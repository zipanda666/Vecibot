<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Admin - Incidentes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <style>
        body { display: flex; height: 100vh; margin: 0; font-family: Arial, sans-serif; padding: 0; }
        #left { width: 380px; overflow-y: auto; border-right: 1px solid #ccc; padding: 20px; background-color: #f8f9fa; }
        #map { flex: 1; height: 100vh; }
        .inc { border-bottom: 1px solid #eee; padding: 12px; margin-bottom: 8px; background: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn { width: 100%; margin-bottom: 15px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6; }
        .header h3 { margin: 0; }
    </style>
</head>
<body>
    <div id="left">
        <div class="header">
            <h3>Panel de la comisar√≠a</h3>
        </div>
        <a href="/stats?token={{ ADMIN_TOKEN }}" class="btn btn-primary">Ver Estad√≠sticas</a>
        <div id="list"></div>
    </div>

    <div id="map"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        const token = new URLSearchParams(window.location.search).get('token') || '';
        const socket = io();
        const listEl = document.getElementById('list');
        const map = L.map('map').setView([0,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
        const markers = {};

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        function refreshList() {
            fetch('/incidents')
                .then(r => r.json())
                .then(data => {
                    listEl.innerHTML = '';
                    data.forEach(inc => {
                        const div = document.createElement('div'); 
                        div.className = 'inc';
                        div.innerHTML = `
                            <b>ID ${escapeHtml(inc.id)}</b> <small>${escapeHtml(inc.created_at || '')}</small><br>
                            <strong>${escapeHtml(inc.status || '').toUpperCase()}</strong> - ${escapeHtml(inc.category || '')}<br>
                            <div>${escapeHtml(inc.message || '')}</div>
                            <div style="font-size:11px;color:#666">${escapeHtml(inc.address || '')}</div>
                            <hr>
                            <div><b>üë§ ${escapeHtml(inc.reporter_name || inc.username || '---')}</b></div>
                            <div><b>üìû ${escapeHtml(inc.reporter_phone || '---')}</b></div>
                            <div><b>ü™™ DNI:</b> ${escapeHtml(inc.reporter_dni || '---')}</div>
                            <hr>
                            <button class="btn btn-success btn-resolve" data-id="${escapeHtml(inc.id)}">‚úÖ Marcar resuelto</button>
                            <button class="btn btn-warning btn-respond" data-id="${escapeHtml(inc.id)}">üí¨ Responder</button>
                        `;
                        listEl.appendChild(div);
                        addOrUpdate(inc);
                    });

                    // Agregar eventos a los botones
                    document.querySelectorAll('.btn-resolve').forEach(btn => {
                        btn.addEventListener('click', () => resolve(btn.dataset.id));
                    });
                    document.querySelectorAll('.btn-respond').forEach(btn => {
                        btn.addEventListener('click', () => respondPrompt(btn.dataset.id));
                    });
                })
                .catch(err => console.error("Error cargando incidentes:", err));
        }

        function addOrUpdate(inc) {
            if (!inc.lat || !inc.lon) return;
            const lat = inc.lat, lon = inc.lon;
            const color = inc.status === 'open' ? 'red' : 'gray';

            if (markers[inc.id]) {
                markers[inc.id].setLatLng([lat, lon]);
                markers[inc.id].setStyle({color, fillColor: color});
            } else {
                const m = L.circleMarker([lat, lon], {radius:8, color, fillColor:color, fillOpacity:0.8}).addTo(map);
                m.bindPopup(`
                    <b>ID:</b> ${escapeHtml(inc.id)}<br>
                    <b>Estado:</b> ${escapeHtml(inc.status)}<br>
                    <b>üìç Direcci√≥n:</b> ${escapeHtml(inc.address || '')}<br>
                    <b>üë§ ${escapeHtml(inc.reporter_name || '---')}</b><br>
                    <b>üìû ${escapeHtml(inc.reporter_phone || '---')}</b>
                `);
                markers[inc.id] = m;
            }
        }

        function resolve(id) {
            fetch('/admin/resolve?token=' + encodeURIComponent(token), {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({id})
            })
            .then(r => r.json())
            .then(res => {
                console.log("‚úîÔ∏è Resuelto:", res);
                refreshList();
            })
            .catch(e => console.error("‚ùå Error resolviendo:", e));
        }

        function respondPrompt(id) {
            const msg = prompt('Mensaje para el usuario:');
            if (!msg) return;
            fetch('/admin/respond?token=' + encodeURIComponent(token), {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({id, message: msg})
            })
            .then(r => r.json())
            .then(res => {
                console.log("üí¨ Respuesta enviada:", res);
                refreshList();
            })
            .catch(e => console.error("‚ùå Error respondiendo:", e));
        }

        socket.on('new_incident', inc => { addOrUpdate(inc); refreshList(); });
        socket.on('update_incident', inc => { addOrUpdate(inc); refreshList(); });
        refreshList();
    </script>
</body>
</html>
