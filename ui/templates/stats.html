<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Estad√≠sticas de Incidentes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { padding: 20px; font-family: Arial, sans-serif; }
    .chart-container { margin: 20px 0; position: relative; height: 300px; }
    .filters { background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
    .back-link { margin-bottom: 20px; display: inline-block; }
    table { font-size: 14px; }
    .star { color: gold; }
  </style>
</head>
<body>
  <a href="/admin?token={{ ADMIN_TOKEN }}" class="btn btn-secondary back-link">‚Üê Volver al Panel</a>
  <h2>üìä Estad√≠sticas de Incidentes</h2>

  <div class="filters">
    <div class="row g-3">
      <div class="col-md-3">
        <label for="yearFilter" class="form-label">A√±o</label>
        <select id="yearFilter" class="form-select">
          <option value="">Todos los a√±os</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="monthFilter" class="form-label">Mes</label>
        <select id="monthFilter" class="form-select">
          <option value="">Todos los meses</option>
          <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
          <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
          <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
          <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="statusFilter" class="form-label">Estado</label>
        <select id="statusFilter" class="form-select">
          <option value="">Todos los estados</option>
          <option value="open">Abiertos</option>
          <option value="resolved">Resueltos</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="userFilter" class="form-label">Usuario</label>
        <select id="userFilter" class="form-select">
          <option value="">Todos los usuarios</option>
        </select>
      </div>
      <div class="col-md-3 mt-3">
        <button id="applyFilters" class="btn btn-primary w-100">Aplicar Filtros</button>
      </div>
    </div>
  </div>

  <!-- === GR√ÅFICOS === -->
  <div class="row">
    <div class="col-md-8">
      <h4>üìÖ Incidentes por D√≠a</h4>
      <div class="chart-container"><canvas id="dailyChart"></canvas></div>
    </div>
    <div class="col-md-4">
      <h4>üè∑Ô∏è Por Categor√≠a</h4>
      <div class="chart-container"><canvas id="categoryChart"></canvas></div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-6">
      <h4>üîç Por Estado</h4>
      <div class="chart-container"><canvas id="statusChart"></canvas></div>
    </div>
    <div class="col-md-6">
      <h4>‚è∞ Por Hora del D√≠a</h4>
      <div class="chart-container"><canvas id="hourlyChart"></canvas></div>
    </div>
  </div>

  <!-- === TABLA DETALLADA DE INCIDENTES === -->
  <div class="mt-5">
    <h4>üìã Listado de Incidentes</h4>
    <div class="table-responsive">
      <table class="table table-striped table-hover" id="incidentsTable">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Usuario</th>
            <th>Fecha</th>
            <th>Categor√≠a</th>
            <th>Descripci√≥n</th>
            <th>Estado</th>
            <th>‚≠ê Calificaci√≥n</th>
            <th>üí¨ Comentario</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let dailyChart, categoryChart, statusChart, hourlyChart;
      const token = new URLSearchParams(window.location.search).get('token') || '';

      const yearFilter = document.getElementById('yearFilter');
      const monthFilter = document.getElementById('monthFilter');
      const statusFilter = document.getElementById('statusFilter');
      const userFilter = document.getElementById('userFilter');

      // === Inicializar a√±o actual ===
      const initYearFilter = () => {
        const current = new Date().getFullYear();
        for (let y = current; y >= 2020; y--) {
          const opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y;
          yearFilter.appendChild(opt);
        }
        yearFilter.value = current;
      };

      // === Cargar usuarios en filtro ===
      const loadUsers = async () => {
        const res = await fetch(`/api/users/list?token=${token}`);
        const users = await res.json();
        users.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = u.full_name || u.username;
          userFilter.appendChild(opt);
        });
      };

      // === Cargar estad√≠sticas ===
      const loadStats = () => {
        const year = yearFilter.value;
        const month = monthFilter.value;
        const status = statusFilter.value;

        fetch(`/api/incidents/stats?year=${year}&month=${month}&status=${status}&token=${token}`)
          .then(r => r.json())
          .then(data => updateCharts(data))
          .catch(e => console.error("Error cargando estad√≠sticas:", e));

        loadIncidentList(); // tambi√©n recarga la tabla
      };

      // === Cargar lista de incidentes ===
      const loadIncidentList = () => {
        const year = yearFilter.value;
        const month = monthFilter.value;
        const status = statusFilter.value;
        const user = userFilter.value;

        fetch(`/api/incidents/list?year=${year}&month=${month}&status=${status}&user=${user}&token=${token}`)
          .then(r => r.json())
            .then(data => {
            if (!Array.isArray(data)) {
                console.error("Respuesta inesperada:", data);
                updateIncidentTable([]);
                return;
            }
            updateIncidentTable(data);
            })
        .catch(e => console.error("Error cargando lista:", e));

      };

      // === Actualizar tablas ===
      const updateIncidentTable = (data) => {
        const tbody = document.querySelector('#incidentsTable tbody');
        tbody.innerHTML = '';
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay registros</td></tr>';
          return;
        }

        data.forEach(inc => {
          const tr = document.createElement('tr');
          const stars = '‚≠ê'.repeat(inc.rating || 0);
          tr.innerHTML = `
            <td>${inc.id}</td>
            <td>${inc.usuario}</td>
            <td>${new Date(inc.fecha).toLocaleDateString()}</td>
            <td>${inc.categoria}</td>
            <td>${inc.descripcion}</td>
            <td>${inc.estado === 'resolved' ? '‚úÖ Resuelto' : 'üïì Abierto'}</td>
            <td>${stars || '‚Äî'}</td>
            <td>${inc.comentario || '‚Äî'}</td>
          `;
          tbody.appendChild(tr);
        });
      };

      // === Actualizar gr√°ficos ===
      const updateCharts = (data) => {
        if (data.daily) updateDailyChart(data.daily);
        if (data.categories) updateCategoryChart(data.categories);
        if (data.status) updateStatusChart(data.status);
        if (data.hourly) updateHourlyChart(data.hourly);
      };

      const updateDailyChart = ({ labels, data }) => {
        if (dailyChart) dailyChart.destroy();
        dailyChart = new Chart(document.getElementById('dailyChart'), {
          type: 'bar',
          data: { labels, datasets: [{ label: 'Incidentes por D√≠a', data, backgroundColor: 'rgba(54,162,235,0.6)' }] },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
      };

      const updateCategoryChart = ({ labels, data }) => {
        if (categoryChart) categoryChart.destroy();
        categoryChart = new Chart(document.getElementById('categoryChart'), {
          type: 'pie',
          data: { labels, datasets: [{ data, backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF'] }] },
          options: { responsive: true }
        });
      };

      const updateStatusChart = ({ labels, data }) => {
        if (statusChart) statusChart.destroy();
        statusChart = new Chart(document.getElementById('statusChart'), {
          type: 'doughnut',
          data: { labels, datasets: [{ data, backgroundColor: ['#E74C3C','#2ECC71','#F1C40F'] }] },
          options: { responsive: true }
        });
      };

      const updateHourlyChart = (data) => {
        if (hourlyChart) hourlyChart.destroy();
        const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
        hourlyChart = new Chart(document.getElementById('hourlyChart'), {
          type: 'line',
          data: { labels: hours, datasets: [{ label: 'Incidentes por Hora', data, borderColor: '#36A2EB', fill: false }] },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
      };

      initYearFilter();
      loadUsers().then(loadStats);
      document.getElementById('applyFilters').addEventListener('click', loadStats);
    });
  </script>
</body>
</html>
